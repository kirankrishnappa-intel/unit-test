# SPDX-License-Identifier: GPL-2.0-or-later
# Makefile for Intel Bluetooth Test Generic Driver
#
# Usage:
#   make modules          - Build kernel module
#   make clean            - Remove build artifacts
#   make install          - Install module to system
#   make load             - Load module into kernel
#   make unload           - Unload module from kernel
#   make reload           - Unload and reload module

# ============================================================================
# CONFIGURATION
# ============================================================================

DRIVER_NAME := btintel_test_generic_driver
MODULE_NAME := $(DRIVER_NAME)
KERNEL_DIR ?= /lib/modules/$(shell uname -r)/build

# Source files
SOURCES := btintel_test_generic_driver.c
HEADERS := btintel_test_generic_driver.h

# Module object
obj-m += $(MODULE_NAME).o
$(MODULE_NAME)-objs := $(SOURCES:.c=.o)

# Debug flags (uncomment to enable)
# EXTRA_CFLAGS += -DDEBUG -g

# ============================================================================
# BUILD TARGETS
# ============================================================================

all: modules

modules:
	@echo "Building $(DRIVER_NAME) module..."
	@make -C $(KERNEL_DIR) M=$(CURDIR) modules

modules_install:
	@echo "Installing $(DRIVER_NAME) module..."
	@make -C $(KERNEL_DIR) M=$(CURDIR) modules_install

clean:
	@echo "Cleaning $(DRIVER_NAME) build artifacts..."
	@make -C $(KERNEL_DIR) M=$(CURDIR) clean
	@rm -f *.o *.ko *.mod.c *.mod.o .*.cmd Module.symvers modules.order
	@rm -rf .tmp_versions

# ============================================================================
# MODULE OPERATIONS (require root)
# ============================================================================

load:
	@if [ ! -f "$(MODULE_NAME).ko" ]; then \
		echo "Error: $(MODULE_NAME).ko not found. Run 'make modules' first."; \
		exit 1; \
	fi
	@echo "Loading $(DRIVER_NAME) module..."
	@sudo insmod $(MODULE_NAME).ko || echo "Module load failed (may already be loaded)"
	@echo "Device file: /dev/$(DRIVER_NAME)0"

unload:
	@echo "Unloading $(DRIVER_NAME) module..."
	@sudo rmmod $(MODULE_NAME) 2>/dev/null || echo "Module not currently loaded"

reload: unload load

# ============================================================================
# UTILITY TARGETS
# ============================================================================

info:
	@echo "$(DRIVER_NAME) Build Information"
	@echo "================================"
	@echo "Driver Name: $(DRIVER_NAME)"
	@echo "Module Name: $(MODULE_NAME)"
	@echo "Kernel Dir:  $(KERNEL_DIR)"
	@echo "Sources:     $(SOURCES)"
	@echo "Headers:     $(HEADERS)"
	@echo ""
	@echo "Available targets:"
	@echo "  make modules      - Build kernel module"
	@echo "  make clean        - Remove build artifacts"
	@echo "  make install      - Install module"
	@echo "  make load         - Load module (requires root)"
	@echo "  make unload       - Unload module (requires root)"
	@echo "  make reload       - Unload and reload module"
	@echo "  make info         - Show this information"

status:
	@echo "Module Status:"
	@lsmod | grep -q "$(MODULE_NAME)" && \
		echo "$(MODULE_NAME) is LOADED" || \
		echo "$(MODULE_NAME) is NOT loaded"
	@echo ""
	@echo "Device File:"
	@if [ -e "/dev/$(DRIVER_NAME)0" ]; then \
		ls -l /dev/$(DRIVER_NAME)0; \
	else \
		echo "/dev/$(DRIVER_NAME)0 not found"; \
	fi

dmesg:
	@echo "Recent kernel messages:"
	@dmesg | grep "$(DRIVER_NAME)" | tail -10

log:
	@echo "Full module log:"
	@journalctl -u kernel --no-pager | grep "$(DRIVER_NAME)" | tail -20

test-ioctl:
	@echo "Testing IOCTL interface..."
	@echo "To implement: Create a user-space test program with:"
	@echo "  1. Open /dev/$(DRIVER_NAME)0"
	@echo "  2. Call ioctl(fd, BTINTEL_TEST_IOC_GET_INFO, &info)"
	@echo "  3. Check returned values"

# ============================================================================
# DEVELOPMENT TARGETS
# ============================================================================

check-syntax:
	@echo "Checking C syntax..."
	@gcc -fsyntax-only -I$(KERNEL_DIR)/include $(SOURCES)

indent:
	@echo "Running code indentation..."
	@for file in $(SOURCES) $(HEADERS); do \
		echo "  Formatting $$file..."; \
		indent -kr -i8 $$file && rm -f $$file~; \
	done

help:
	@echo "Intel Bluetooth Test Generic Driver - Makefile Targets"
	@echo ""
	@echo "Build targets:"
	@echo "  make modules           Build the kernel module"
	@echo "  make modules_install   Install module to system paths"
	@echo "  make clean             Clean all build artifacts"
	@echo ""
	@echo "Runtime targets (require root):"
	@echo "  make load              Load module into kernel"
	@echo "  make unload            Remove module from kernel"
	@echo "  make reload            Unload and reload module"
	@echo ""
	@echo "Information targets:"
	@echo "  make info              Show build configuration"
	@echo "  make status            Show module load status"
	@echo "  make dmesg             Show recent kernel messages"
	@echo "  make log               Show full module log entries"
	@echo ""
	@echo "Development targets:"
	@echo "  make check-syntax      Check C code syntax"
	@echo "  make indent            Auto-format code indentation"
	@echo "  make test-ioctl        Instructions for IOCTL testing"

.PHONY: all modules modules_install clean load unload reload info status dmesg log help check-syntax indent test-ioctl
